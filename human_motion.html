<!DOCTYPE html>
<html>
<head>
	<link rel = "stylesheet" href = "webpage_style.css">
	<script src = "script.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
	<h1>Human Motion Sensor</h1>
	<input id = "input" type = "text" placeholder = "Input charger number..." autocomplete="off">
	<button id = "button" onclick = "printChargerNum()">search</button>
	<p id = "output" class = "textStyle"></p><br/>
	<p id = "data" class = "dataShow"></p>
	<table>
		<tr>
			<td><p>OFF</p></td>
			<td><label class = "switch">
				<input type = "checkbox">
				<span class = "slider"></span>
				</label>
			</td>
			<td><p>ON</p></td>
		</tr>
	</table>
	<p id = "warning" class = "dataShow"></p>
	<button onclick = "exportToExcel(data)">Generate Log</button>
	<script>
        const data = [];
		function printChargerNum(){
			const chargerNum = document.getElementById("input").value.trim();
			const outputNum = document.getElementById("output");
			const outputData = document.getElementById("data");
			const checkError = ("No");
			const checkHuman = ("Yes");
			const chargerNumFormat = /^CDJ\d{6}$/;/*charger number format, must start with CDJ follow by six digit number*/
			const dataDisplay = {ChargerNo: chargerNum, Error: checkError, HumanActivity: checkHuman};
			if (chargerNum === ""){/*check if input is empty*/
				outputData.textContent = "";
				outputNum.innerHTML = "Please input charger number."
				outputNum.style.backgroundColor = "red";
			}else if(!chargerNumFormat.test(chargerNum)){/*check if charger number satisfies format*/
				outputData.textContent = "";
				outputNum.innerHTML = "Charger number must start with 'CDJ' follow by a six digit number."
				outputNum.style.backgroundColor = "#f0a23c";
			}else{
				outputNum.innerHTML = "Now controlling charger: " + chargerNum;
				outputNum.style.backgroundColor = "#a6f263";
				const existData = data.find(entry => entry.ChargerNo === chargerNum);
				if (!existData) {
					data.push(dataDisplay);
					outputData.textContent = `ChargerNo: ${chargerNum}, Error: ${checkError}, HumanActivity: ${checkHuman}`;
				}else{
					outputData.textContent = `ChargerNo: ${chargerNum}, Error: ${checkError}, HumanActivity: ${checkHuman}`;
				}
			}
			document.getElementById("input").value = '';/*set input to empty after button clicked*/
		}
        function exportToExcel(data) {
			const warningData = document.getElementById("warning");
			const validData = data.filter(entry => entry.ChargerNo && /^CDJ\d{6}$/.test(entry.ChargerNo));/*only allow data with valid charger number been input*/
			if (validData.length === 0) {
				warningData.textContent =("No valid charger data to export.");
				warningData.style.backgroundColor = "red";
				return;
			}else{
				warningData.textContent = "";
				warningData.style.backgroundColor = "transparent";
				const workbook = XLSX.utils.book_new();
				const worksheet = XLSX.utils.json_to_sheet(data);
				XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
				XLSX.writeFile(workbook, "humanmotionLog.xlsx");
			}
        }
    </script>
</body>
</html>
